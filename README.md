# Generate RELION Euler angles and rotation origins from UCSF Chimera sessions

<strong>Overview:</strong>



<strong>Installation</strong>

The easiest way to manage the libraries needed to run these scripts is to install <a href="https://www.anaconda.com/products/individual">Anaconda</a>, and use it to generate the follwing environments:

<code>pychimera</code>, with the libraries necessary to interpret UCSF Chimera session files.

<code>py37</code>, with a version scipy that has the Rotation object.

1) Install Anaconda following the instruction in their website.

2) Clone this repository:

<code>git clone https://github.com/GrotjahnLab/guided_tomo_align.git</code>
<code>cd guided_tomo_align</code>

3) For the pychimera library to work, you need to install UCSF Chimera and direct pychimera to its directory. See pychimeras' help for more information, specially points 2 and 4 in this <a href="https://pychimera.readthedocs.io/en/latest/install.html">page</a>. Avoiding launching of the UCSF Chimera GUI may be desirable, specially when working from a computing cluster. For this, make sure you obtain the UCSF Chimera "headless" version. In order to execute the downloaded \*.bin file, make it into an executable by running <code>chmod +x ucsfchimera\_download.bin</code>. Finally, set the CHIMERADIR environment variable (in bash): <code>export CHIMERADIR=/your/chimera/intallation/dir/</code>

4) Create <code>pychimera</code> and <code>py37</code> using the provided \*.yml files:

<code>conda env create -f ./pychimera.yml</code>
<code>conda env create -f ./py37.yml</code>

5) First, activate the pychimera environment using <code>conda activate pychimera</code> to run <code>chim\_session\_to\_mtx.py</code>. You can print a help message typing:

<code>python ./chim\_session\_to\_mtx.py --help</code>

It will generate the following output:

<plaintext>usage: mtx_to_star.py [-h] --template_star TEMPLATE_STAR --chimera_mtx_output
  
                      CHIMERA_MTX_OUTPUT
                      [--rln_particle_particle_csv RLN_PARTICLE_PARTICLE_CSV]
                      [--angpix ANGPIX] [--output_name OUTPUT_NAME]

Use transformation matrices generated by chim_session_to_mtx.py to populate a
template relion star file Euler angles and rotation origins.

optional arguments:
  -h, --help            show this help message and exit
  --template_star TEMPLATE_STAR
                        RELION *.star file to use as template.
  --chimera_mtx_output CHIMERA_MTX_OUTPUT
                        Output file from chim_session_to_mtx.py
  --rln_particle_particle_csv RLN_PARTICLE_PARTICLE_CSV
                        A "coma separated values" file denoting equivalences
                        between the naming of particles in the *.star file and
                        chimera sessions. E.g., if a particle is named "Partic
                        les/Tomograms/tomogram101/tomogram101_subtomo000004.mr
                        c" in the star file, and "tomo1_4.mrc" in the Chimersa
                        session, the *.csv file should have a line with the
                        following format:
                        "tomogram101_subtomo000004.mrc,tomo1_4.mrc". There
                        should be one pair per line.
  --angpix ANGPIX       Particle pixel size.
  --output_name OUTPUT_NAME
                        Name for output *.star file</plaintext>

Here's an commandline example:

<code>python ./chim\_session\_to\_mtx.py --sessions_path /path/to/chimerasessions/ --reference_name reference.mrc --particle_name_prefix deconv_lam2_TS4 --particle_angpix 10.88 --reference_angpix 10.88 --r_box 44,44,44 --p_box 44,44,44</code>

6) Then, activate the py37 environment using <code>conda activate py37</code> to run <code>mtx\_to\_star.py</code>.

7) There is a known issue with some UCSF Chimera installations where the libgfxinfo.so library will produce a "undefined symbol" error. We have been able to fix this by removing the pcre package from the pychimera environment: <code>conda remove --force pcre</code>
